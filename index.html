<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>ç„¡å°¾ç†Šç³–æœå±‹ ğŸ¨ğŸ“±</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#fff0f5">
    
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Varela+Round&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-color: #fff0f5;
            --glass: rgba(255, 255, 255, 0.9);
            --primary: #ff80ab;
            --accent: #8c9eff;
            --text: #880e4f;
        }

        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; position: fixed;
            overscroll-behavior: none; touch-action: none;
            background: var(--bg-color);
            font-family: 'Varela Round', sans-serif;
            user-select: none; -webkit-user-select: none;
            color: var(--text);
        }

        /* === 0. ç™»å…¥ç•«é¢ (Start Screen) === */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #fff0f5 0%, #ffebee 100%);
            z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }
        .title-logo {
            font-family: 'Fredoka'; font-size: 3.5rem; color: #ff80ab;
            text-shadow: 3px 3px 0 white; margin-bottom: 20px;
            animation: float 3s infinite ease-in-out;
        }
        .start-btn {
            background: linear-gradient(90deg, #ff80ab, #ff4081);
            color: white; padding: 15px 50px; border-radius: 30px;
            font-size: 1.5rem; font-weight: bold; border: none;
            box-shadow: 0 5px 15px rgba(255, 64, 129, 0.4);
            animation: pulse 1.5s infinite; cursor: pointer;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* === 1. é ‚éƒ¨ UI (Top Bar) === */
        .top-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100px;
            padding: 10px 15px; display: flex; justify-content: space-between; align-items: flex-end;
            z-index: 100; pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ°ä¸‹æ–¹ */
        }
        
        /* å·¦ä¸Šï¼šç„¡å°¾ç†Šèˆ‡ç‹€æ…‹ */
        .profile-card {
            pointer-events: auto;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(5px);
            padding: 5px 10px 5px 5px; border-radius: 30px;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border: 2px solid white;
        }
        .koala-avatar { width: 45px; height: 45px; position: relative; }
        #koala-svg { width: 100%; height: 100%; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
        
        .level-info { display: flex; flex-direction: column; justify-content: center; }
        .level-badge { font-size: 0.7rem; font-weight: bold; color: #8c9eff; }
        .xp-track { width: 60px; height: 6px; background: #eee; border-radius: 5px; overflow: hidden; margin-top: 2px; }
        .xp-fill { width: 0%; height: 100%; background: #8c9eff; transition: width 0.5s; }

        /* å³ä¸Šï¼šé‡‘å¹£èˆ‡é¸å–® */
        .right-tools {
            pointer-events: auto; display: flex; gap: 10px; align-items: center;
        }
        .coin-pill {
            background: white; padding: 5px 12px; border-radius: 20px;
            display: flex; align-items: center; gap: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 2px solid white;
        }
        .menu-btn {
            width: 40px; height: 40px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #880e4f; font-size: 1.2rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer;
        }

        /* === 2. éŠæˆ²å€ === */
        .game-area {
            position: absolute; top: 100px; bottom: 130px; width: 100%;
            display: flex; justify-content: center; align-items: center;
        }
        #board-container {
            width: 90vw; max-width: 360px; aspect-ratio: 1/1;
            background: rgba(255,255,255,0.8); border-radius: 24px; padding: 10px;
            box-shadow: 0 10px 30px rgba(255, 128, 171, 0.15);
            border: 4px solid white; transition: transform 0.1s;
        }
        canvas#game-canvas { width: 100%; height: 100%; border-radius: 16px; display: block; }
        .shake-hard { animation: shakeHard 0.4s both; }
        @keyframes shakeHard { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px) rotate(-2deg)} 75%{transform:translateX(5px) rotate(2deg)} }

        /* === 3. åº•éƒ¨ç”Ÿæˆå€ === */
        #spawn-area {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 130px;
            background: white; border-top-left-radius: 30px; border-top-right-radius: 30px;
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: 20px; z-index: 50;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }
        .shape-preview { width: 60px; height: 60px; touch-action: none; }
        .shape-preview.dragging { opacity: 0.9; z-index: 9999; position: fixed; transform: scale(1.2); pointer-events: none; margin: 0; }

        /* === å…¨è¢å¹•é¸å–® (Overlay Menu) === */
        #menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 2000;
            display: none; flex-direction: column; padding: 30px;
            backdrop-filter: blur(10px); animation: fadeIn 0.2s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .menu-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;
        }
        .menu-card {
            background: white; padding: 20px; border-radius: 20px; text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 2px solid #fff0f5;
            transition: 0.1s; cursor: pointer;
        }
        .menu-card:active { transform: scale(0.95); background: #fff0f5; }
        .menu-icon { font-size: 2.5rem; margin-bottom: 10px; display: block; }
        .menu-label { font-weight: bold; color: #880e4f; }

        /* === å½ˆçª—æ¨£å¼ === */
        .modal-base {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 5000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-box {
            background: white; width: 85%; max-width: 320px; border-radius: 25px;
            padding: 25px; text-align: center; position: relative;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .close-modal {
            position: absolute; top: 15px; right: 15px; width: 30px; height: 30px;
            background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: #666;
        }

        /* åˆ—è¡¨æ¨£å¼ */
        .list-container { max-height: 300px; overflow-y: auto; margin-top: 15px; }
        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; background: #f9f9f9; border-radius: 15px; margin-bottom: 10px;
        }
        .btn-action {
            background: var(--primary); color: white; border: none;
            padding: 5px 15px; border-radius: 15px; font-weight: bold;
        }

        /* å‡ç´šç‰¹æ•ˆ */
        #levelup-modal { pointer-events: none; }
        .levelup-text {
            font-family: 'Fredoka'; font-size: 3rem; color: #ffeb3b;
            text-shadow: 0 5px 0 #fbc02d; animation: bounceIn 1s;
        }

        /* æ°£æ³¡ */
        .bubble { position: absolute; top: 80px; left: 70px; background: white; padding: 6px 12px; border-radius: 15px; border-bottom-left-radius: 0; box-shadow: 0 3px 10px rgba(0,0,0,0.1); font-size: 0.8rem; color: #880e4f; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 150; }
        .bubble.show { opacity: 1; transform: translateY(-5px); }
    </style>
</head>
<body>

<!-- 0. ç™»å…¥ç•«é¢ -->
<div id="start-screen">
    <div class="title-logo">ç„¡å°¾ç†Š<br>ç³–æœå±‹</div>
    <div style="font-size:4rem; margin:20px;">ğŸ¨ğŸ’¤</div>
    <button class="start-btn" onclick="startGame()">é»æ“Šå–šé†’</button>
</div>

<!-- 1. é ‚éƒ¨ UI -->
<div class="top-ui">
    <div class="profile-card" onclick="petKoala()">
        <div class="koala-avatar">
            <svg id="koala-svg" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="45" fill="#eceff1"/>
                <circle cx="20" cy="30" r="15" fill="#cfd8dc"/> <circle cx="80" cy="30" r="15" fill="#cfd8dc"/>
                <g id="eyes"><circle cx="35" cy="45" r="5" fill="#455a64"/><circle cx="65" cy="45" r="5" fill="#455a64"/></g>
                <ellipse cx="50" cy="55" rx="10" ry="7" fill="#455a64"/>
                <circle cx="25" cy="60" r="6" fill="rgba(255,128,171,0.4)"/> <circle cx="75" cy="60" r="6" fill="rgba(255,128,171,0.4)"/>
                <!-- é£¾å“ -->
                <g id="acc-bow" style="display:none"><path d="M30 20 L50 30 L70 20 L50 40 Z" fill="#ff4081"/><circle cx="50" cy="30" r="5" fill="#f50057"/></g>
                <g id="acc-glasses" style="display:none"><rect x="25" y="40" width="20" height="10" rx="2" fill="#333"/><rect x="55" y="40" width="20" height="10" rx="2" fill="#333"/><line x1="45" y1="45" x2="55" y2="45" stroke="#333" stroke-width="2"/></g>
                <g id="acc-crown" style="display:none"><path d="M30 25 L40 10 L50 25 L60 10 L70 25 L70 30 L30 30 Z" fill="#ffd700"/></g>
            </svg>
        </div>
        <div class="level-info">
            <div class="level-badge">LV.<span id="level-num">1</span></div>
            <div class="xp-track"><div class="xp-fill" id="xp-bar"></div></div>
        </div>
    </div>
    
    <div class="right-tools">
        <div class="coin-pill">
            <i class="fas fa-leaf" style="color:#4caf50;"></i>
            <span id="score" style="font-weight:bold; color:#555;">0</span>
        </div>
        <div class="menu-btn" onclick="toggleMenu(true)"><i class="fas fa-bars"></i></div>
    </div>
</div>

<div class="bubble" id="msg">Zzz...</div>

<!-- 2. éŠæˆ²å€ -->
<div class="game-area">
    <div id="board-container">
        <canvas id="game-canvas" width="800" height="800"></canvas>
    </div>
</div>

<!-- 3. ç”Ÿæˆå€ -->
<div id="spawn-area"></div>

<!-- å…¨è¢å¹•é¸å–® -->
<div id="menu-overlay">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1 style="margin:0; color:#880e4f;">é¸å–®</h1>
        <div class="close-modal" onclick="toggleMenu(false)"><i class="fas fa-times"></i></div>
    </div>
    
    <div class="menu-grid">
        <div class="menu-card" onclick="openModal('shop')">
            <span class="menu-icon">ğŸ</span>
            <span class="menu-label">è¨±é¡˜å•†åº—</span>
        </div>
        <div class="menu-card" onclick="openModal('wardrobe')">
            <span class="menu-icon">ğŸ‘—</span>
            <span class="menu-label">ç„¡å°¾ç†Šè¡£æ«ƒ</span>
        </div>
        <div class="menu-card" onclick="toggleSound()">
            <span class="menu-icon" id="sound-icon">ğŸ”Š</span>
            <span class="menu-label">éŸ³æ•ˆé–‹é—œ</span>
        </div>
        <div class="menu-card" onclick="feed()">
            <span class="menu-icon">ğŸŒ¿</span>
            <span class="menu-label">é¤µé£Ÿ (-50)</span>
        </div>
    </div>
    
    <div style="margin-top:auto; text-align:center; color:#aaa; font-size:0.8rem;">Ver 3.1 Ultimate Edition</div>
</div>

<!-- å•†åº—/è¡£æ«ƒ å½ˆçª— -->
<div id="common-modal" class="modal-base">
    <div class="modal-box">
        <div class="close-modal" onclick="document.getElementById('common-modal').style.display='none'"><i class="fas fa-times"></i></div>
        <h2 id="modal-title" style="margin-top:0; color:#880e4f;">æ¨™é¡Œ</h2>
        <div id="modal-list" class="list-container"></div>
    </div>
</div>

<!-- å‡ç´šå½ˆçª— -->
<div id="levelup-modal" class="modal-base" style="background:rgba(0,0,0,0.3);">
    <div class="levelup-text">LEVEL UP!</div>
</div>

<!-- å¤±æ•—å½ˆçª— -->
<div id="game-over-modal" class="modal-base">
    <div class="modal-box">
        <div style="font-size:4rem;">ğŸ˜­</div>
        <h2>æ²’åœ°æ–¹æ”¾äº†</h2>
        <button class="btn-action" style="font-size:1.2rem; padding:10px 30px;" onclick="game.reset()">é‡ä¾†</button>
    </div>
</div>

<script>
    /* === ç³»çµ±è®Šæ•¸ === */
    let coins = parseInt(localStorage.getItem('xr_coins') || 0);
    let level = parseInt(localStorage.getItem('xr_level') || 1);
    let xp = parseInt(localStorage.getItem('xr_xp') || 0);
    let soundOn = true;
    let ownedSkins = JSON.parse(localStorage.getItem('xr_skins') || '[]');
    let currentSkin = localStorage.getItem('xr_current_skin') || 'none';
    
    /* === éŠæˆ²å•Ÿå‹• === */
    function startGame() {
        document.getElementById('start-screen').style.opacity = 0;
        setTimeout(() => {
            document.getElementById('start-screen').style.display = 'none';
            speak("ä¸»äººå¦³å¥½ â¤ï¸");
        }, 500);
    }

    /* === UI æ›´æ–° === */
    function updateUI() {
        document.getElementById('score').innerText = coins;
        document.getElementById('level-num').innerText = level;
        const maxXp = level * 100;
        document.getElementById('xp-bar').style.width = (xp / maxXp * 100) + '%';
        
        // å„²å­˜
        localStorage.setItem('xr_coins', coins);
        localStorage.setItem('xr_level', level);
        localStorage.setItem('xr_xp', xp);
        
        // å¤–è§€
        ['acc-bow', 'acc-glasses', 'acc-crown'].forEach(id => document.getElementById(id).style.display = 'none');
        if(currentSkin !== 'none') document.getElementById('acc-' + currentSkin).style.display = 'block';
    }
    updateUI();

    function addXP(amount) {
        xp += amount;
        const maxXp = level * 100;
        if(xp >= maxXp) {
            xp -= maxXp; level++;
            showLevelUp();
        }
        updateUI();
    }
    function showLevelUp() {
        const m = document.getElementById('levelup-modal');
        m.style.display = 'flex';
        setTimeout(() => m.style.display = 'none', 1500);
    }

    function toggleMenu(show) {
        document.getElementById('menu-overlay').style.display = show ? 'flex' : 'none';
    }
    function toggleSound() {
        soundOn = !soundOn;
        document.getElementById('sound-icon').innerText = soundOn ? 'ğŸ”Š' : 'ğŸ”‡';
    }

    function speak(text) {
        const b = document.getElementById('msg'); b.innerText = text;
        b.classList.add('show'); setTimeout(()=>b.classList.remove('show'), 2000);
    }
    function petKoala() { speak("æ‘¸æ‘¸é ­ï½"); addXP(10); }
    function feed() {
        if(coins>=50) { coins-=50; addXP(50); speak("å¥½åƒï¼"); updateUI(); } 
        else speak("è‘‰å­ä¸å¤ ...");
    }

    /* === å•†åº—èˆ‡è¡£æ«ƒé‚è¼¯ === */
    const PRIZES = [{n:'æ‰‹æ–é£²', p:8000, i:'ğŸ§‹'}, {n:'æŒ‰æ‘©', p:30000, i:'ğŸ’†â€â™€ï¸'}, {n:'å¤§é¤', p:88000, i:'ğŸ½ï¸'}];
    const SKINS = [{id:'bow', n:'è´è¶çµ', p:2000, i:'ğŸ€'}, {id:'glasses', n:'å¢¨é¡', p:5000, i:'ğŸ•¶ï¸'}, {id:'crown', n:'çš‡å† ', p:10000, i:'ğŸ‘‘'}];

    function openModal(type) {
        toggleMenu(false); // é—œé–‰ä¸»é¸å–®
        const m = document.getElementById('common-modal');
        const t = document.getElementById('modal-title');
        const l = document.getElementById('modal-list');
        m.style.display = 'flex'; l.innerHTML = '';

        if(type === 'shop') {
            t.innerText = 'è¨±é¡˜å•†åº—';
            PRIZES.forEach(p => {
                l.innerHTML += `<div class="list-item">
                    <div><span style="font-size:1.5rem">${p.i}</span> <b>${p.n}</b></div>
                    <button class="btn-action" onclick="if(coins>=${p.p}){coins-=${p.p};updateUI();alert('å…Œæ›æˆåŠŸï¼');}else{alert('éŒ¢ä¸å¤ ')}">${p.p}</button>
                </div>`;
            });
        } else {
            t.innerText = 'ç„¡å°¾ç†Šè¡£æ«ƒ';
            // åŸå‘³
            l.innerHTML += `<div class="list-item"><div>ğŸ¨ åŸå‘³</div><button class="btn-action" onclick="currentSkin='none';localStorage.setItem('xr_current_skin','none');updateUI();">ç©¿æˆ´</button></div>`;
            SKINS.forEach(s => {
                const owned = ownedSkins.includes(s.id);
                l.innerHTML += `<div class="list-item">
                    <div><span style="font-size:1.5rem">${s.i}</span> <b>${s.n}</b></div>
                    <button class="btn-action" style="background:${owned?'#8c9eff':'#ff80ab'}" 
                    onclick="${owned ? `currentSkin='${s.id}';localStorage.setItem('xr_current_skin','${s.id}');updateUI();` : `if(coins>=${s.p}){coins-=${s.p};ownedSkins.push('${s.id}');localStorage.setItem('xr_skins',JSON.stringify(ownedSkins));updateUI();openModal('wardrobe');}else{alert('éŒ¢ä¸å¤ ')}`}">
                    ${owned ? 'ç©¿æˆ´' : s.p}</button>
                </div>`;
            });
        }
    }

    /* === éŠæˆ²å¼•æ“ (ç²¾ç°¡ç‰ˆ) === */
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const SHAPES = [{m:[[1]], c:'#ff8a80'}, {m:[[1,1]], c:'#ff80ab'}, {m:[[1],[1]], c:'#ea80fc'}, {m:[[1,1,1]], c:'#b388ff'}, {m:[[1,1],[1,1]], c:'#8c9eff'}, {m:[[1,1,1],[0,1,0]], c:'#80d8ff'}];
    let grid = Array(8).fill().map(()=>Array(8).fill(0));
    let currentDrag = null; let ghost = null; const CELL = 100;

    function draw() {
        ctx.clearRect(0,0,800,800);
        ctx.strokeStyle = '#fce4ec'; ctx.lineWidth=3; ctx.setLineDash([10, 10]);
        for(let i=0;i<=8;i++) { ctx.beginPath(); ctx.moveTo(0,i*CELL); ctx.lineTo(800,i*CELL); ctx.stroke(); ctx.beginPath(); ctx.moveTo(i*CELL,0); ctx.lineTo(i*CELL,800); ctx.stroke(); }
        ctx.setLineDash([]);
        if(ghost) drawShape(ghost.shape, ghost.x, ghost.y, 'rgba(0,0,0,0.1)');
        for(let y=0;y<8;y++) for(let x=0;x<8;x++) if(grid[y][x]) drawCell(x,y,grid[y][x]);
        requestAnimationFrame(draw);
    }
    function drawCell(x,y,c) {
        let p=6, s=CELL-p*2; ctx.fillStyle=c; ctx.beginPath(); ctx.roundRect(x*CELL+p, y*CELL+p, s, s, 20); ctx.fill();
        ctx.fillStyle='rgba(255,255,255,0.4)'; ctx.beginPath(); ctx.arc(x*CELL+p+15, y*CELL+p+15, 8, 0, Math.PI*2); ctx.fill();
    }
    function drawShape(s,x,y,c) { for(let r=0;r<s.m.length;r++) for(let c2=0;c2<s.m[0].length;c2++) if(s.m[r][c2]) drawCell(x+c2, y+r, c || s.c); }

    function spawn() {
        const area = document.getElementById('spawn-area'); area.innerHTML = '';
        for(let i=0;i<3;i++) {
            const data = SHAPES[Math.floor(Math.random()*SHAPES.length)];
            const el = document.createElement('canvas'); el.width=60; el.height=60; el.className='shape-preview'; el.shapeData = data; 
            const c = el.getContext('2d'); const s=12, ox=(60-data.m[0].length*s)/2, oy=(60-data.m.length*s)/2; c.fillStyle=data.c;
            for(let r=0;r<data.m.length;r++) for(let col=0;col<data.m[0].length;col++) if(data.m[r][col]) { c.beginPath(); c.roundRect(ox+col*s, oy+r*s, s-1, s-1, 3); c.fill(); }
            el.addEventListener('touchstart', (e)=>startDrag(e, el, data), {passive:false});
            el.addEventListener('mousedown', (e)=>startDrag(e, el, data));
            area.appendChild(el);
        }
        checkOver();
    }

    function startDrag(e, el, data) { e.preventDefault(); currentDrag = { el, data }; el.classList.add('dragging'); moveDrag(e); }
    function moveDrag(e) {
        if(!currentDrag) return;
        const evt = e.touches ? e.touches[0] : e; const el = currentDrag.el;
        const offset = 80; const elWidth = 60;
        el.style.left = (evt.clientX - elWidth/2) + 'px'; el.style.top = (evt.clientY - elWidth/2 - offset) + 'px';
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width; const scaleY = canvas.height / rect.height;
        const canvasX = (evt.clientX - rect.left) * scaleX; const canvasY = (evt.clientY - offset - rect.top) * scaleY;
        const gx = Math.floor(canvasX / CELL); const gy = Math.floor(canvasY / CELL);
        const shape = currentDrag.data;
        const px = gx - Math.floor(shape.m[0].length/2); const py = gy - Math.floor(shape.m.length/2);
        let best = null; let minDistance = Infinity;
        for(let dy=-2; dy<=2; dy++) for(let dx=-2; dx<=2; dx++) {
            const tx = px + dx; const ty = py + dy;
            if(canPlace(shape.m, tx, ty)) {
                const dist = Math.sqrt(dx*dx + dy*dy);
                if(dist < minDistance) { minDistance = dist; best = {x: tx, y: ty}; }
            }
        }
        ghost = best ? {x:best.x, y:best.y, shape:shape} : null;
    }
    function endDrag() {
        if(!currentDrag) return;
        if(ghost) { place(ghost.shape, ghost.x, ghost.y); currentDrag.el.remove(); if(document.getElementById('spawn-area').children.length===0) setTimeout(spawn, 300); else checkOver(); }
        else { currentDrag.el.classList.remove('dragging'); currentDrag.el.style.left=''; currentDrag.el.style.top=''; }
        currentDrag = null; ghost = null;
    }
    document.addEventListener('touchmove', moveDrag, {passive:false}); document.addEventListener('mousemove', moveDrag);
    document.addEventListener('touchend', endDrag); document.addEventListener('mouseup', endDrag);

    function canPlace(m, x, y) { for(let r=0;r<m.length;r++) for(let c=0;c<m[0].length;c++) if(m[r][c]) { let nx=x+c, ny=y+r; if(nx<0||nx>=8||ny<0||ny>=8||grid[ny][nx]) return false; } return true; }
    function place(s, x, y) { for(let r=0;r<s.m.length;r++) for(let c=0;c<s.m[0].length;c++) if(s.m[r][c]) grid[y+r][x+c] = s.c; checkLines(); }
    function checkLines() {
        let lines = 0;
        for(let y=0;y<8;y++) if(grid[y].every(c=>c)) { grid[y].fill(0); lines++; }
        for(let x=0;x<8;x++) { let full=true; for(let y=0;y<8;y++) if(!grid[y][x]) full=false; if(full) { for(let y=0;y<8;y++) grid[y][x]=0; lines++; } }
        if(lines>0) {
            coins += lines*10; addXP(lines*10); updateUI();
            document.getElementById('board-container').classList.add('shake-hard');
            setTimeout(()=>document.getElementById('board-container').classList.remove('shake-hard'), 400);
        }
    }
    function checkOver() {
        setTimeout(() => {
            const els = document.querySelectorAll('#spawn-area .shape-preview'); if (els.length === 0) return;
            let canMove = false;
            for (let i = 0; i < els.length; i++) {
                const shape = els[i].shapeData;
                for (let y = 0; y < 8; y++) { for (let x = 0; x < 8; x++) { if (canPlace(shape.m, x, y)) { canMove = true; break; } } if (canMove) break; }
                if (canMove) break;
            }
            if (!canMove) document.getElementById('game-over-modal').style.display = 'flex';
        }, 200);
    }
    const game = { reset: function() { grid = Array(8).fill().map(()=>Array(8).fill(0)); document.getElementById('game-over-modal').style.display='none'; spawn(); } };
    
    draw(); spawn();
</script>
</body>
</html>
