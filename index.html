<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>ÁÑ°Â∞æÁÜäÁ≥ñÊûúÂ±ã üê®üëó</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#fff0f5">
    
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Varela+Round&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-color: #fff0f5;
            --glass: rgba(255, 255, 255, 0.9);
            --primary: #ff80ab;
        }

        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; position: fixed;
            overscroll-behavior: none; touch-action: none;
            background: var(--bg-color);
            font-family: 'Varela Round', sans-serif;
            user-select: none; -webkit-user-select: none;
            transition: background 0.5s;
        }
        
        /* Fever Ê®°ÂºèËÉåÊôØ */
        body.fever-mode { background: #fffde7; }

        /* ËÉåÊôØÊºÇÊµÆÁâ© */
        .bg-blob {
            position: absolute; border-radius: 50%;
            filter: blur(40px); opacity: 0.6; z-index: -1;
            animation: float 10s infinite ease-in-out;
        }
        .blob-1 { width: 200px; height: 200px; background: #ffcdd2; top: -50px; left: -50px; }
        .blob-2 { width: 250px; height: 250px; background: #e1bee7; bottom: -50px; right: -50px; animation-delay: -5s; }
        @keyframes float { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(20px, -20px); } }

        #app-container {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: space-between;
            position: relative; z-index: 1;
        }

        /* === È†ÇÈÉ®Âàó === */
        .header-bar {
            height: 90px; width: 94%; margin: 10px auto 0;
            background: var(--glass); backdrop-filter: blur(10px);
            border-radius: 25px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; box-shadow: 0 8px 32px rgba(255, 128, 171, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.8); z-index: 100;
        }
        .pet-section { display: flex; align-items: center; gap: 12px; }
        
        /* ÁÑ°Â∞æÁÜäÂÆπÂô® */
        .koala-wrapper { position: relative; width: 60px; height: 60px; }
        #koala-svg { 
            width: 100%; height: 100%; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); 
            animation: breathe 3s infinite ease-in-out; cursor: pointer;
        }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .fever-mode #koala-svg { animation: headBang 0.4s infinite; }
        @keyframes headBang { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }

        .status-box { display: flex; flex-direction: column; gap: 4px; }
        .hunger-track { width: 70px; height: 8px; background: #ffebee; border-radius: 10px; overflow: hidden; border: 1px solid #ffcdd2; }
        .hunger-fill { width: 50%; height: 100%; background: linear-gradient(90deg, #ff80ab, #ff4081); transition: width 0.5s; }
        .feed-btn { 
            font-size: 0.7rem; padding: 4px 10px; background: linear-gradient(135deg, #ff80ab, #ff4081); 
            color: white; border:none; border-radius: 15px; font-weight: bold; 
            box-shadow: 0 2px 5px rgba(255, 64, 129, 0.3); transition: transform 0.1s;
        }
        .feed-btn:active { transform: scale(0.9); }

        .menu-section { display: flex; gap: 8px; align-items: center; }
        .score-pill {
            background: white; padding: 5px 10px; border-radius: 20px; min-width: 80px; text-align: center;
            font-family: 'Fredoka'; font-size: 1.1rem; color: #ec407a; font-weight: bold;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }
        .nav-btn { 
            font-size: 1rem; color: white; width: 38px; height: 38px; 
            border-radius: 50%; display:flex; align-items:center; justify-content:center; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); transition: transform 0.1s;
        }
        .nav-btn:active { transform: scale(0.9); }
        .btn-shop { background: #8c9eff; }
        .btn-wardrobe { background: #ffb74d; }

        /* === ÈÅäÊà≤ÂçÄ === */
        .game-area {
            flex: 1; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 10px; position: relative;
        }
        #board-container {
            width: 90vw; max-width: 360px; aspect-ratio: 1/1;
            background: rgba(255,255,255,0.9); border-radius: 24px; padding: 10px;
            box-shadow: 0 15px 35px rgba(255, 128, 171, 0.15), inset 0 -5px 0 rgba(0,0,0,0.05);
            border: 4px solid white; transition: transform 0.1s;
        }
        .shake-hard { animation: shakeHard 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shakeHard { 
            10%, 90% { transform: translate3d(-2px, 0, 0) rotate(-1deg); } 
            20%, 80% { transform: translate3d(4px, 0, 0) rotate(1deg); } 
            30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } 
            40%, 60% { transform: translate3d(6px, 0, 0); } 
        }
        canvas#game-canvas { width: 100%; height: 100%; border-radius: 16px; display: block; }

        /* === ÁîüÊàêÂçÄ === */
        #spawn-area {
            height: 120px; width: 100%;
            display: flex; justify-content: space-around; align-items: center;
            background: rgba(255,255,255,0.5);
            border-top-left-radius: 30px; border-top-right-radius: 30px;
            backdrop-filter: blur(5px); padding-bottom: 15px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }
        .shape-preview { width: 60px; height: 60px; touch-action: none; filter: drop-shadow(0 4px 0 rgba(0,0,0,0.1)); }
        .shape-preview.dragging {
            opacity: 0.9; z-index: 9999; position: fixed;
            transform: scale(1.2); pointer-events: none;
            will-change: left, top; margin: 0;
        }

        /* === ÂΩàÁ™óÈÄöÁî®Ê®£Âºè === */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 240, 245, 0.95); z-index: 200;
            display: none; flex-direction: column; padding: 20px;
            backdrop-filter: blur(10px); animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 40px; }
        .modal-title { color: #880e4f; margin: 0; font-size: 1.8rem; }
        .close-btn { width: 40px; height: 40px; border-radius: 50%; background: #ff8a80; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* ÂïÜÂ∫óÈ†ÖÁõÆ */
        .shop-item {
            background: white; padding: 15px; margin-bottom: 15px; border-radius: 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 2px solid white;
        }
        
        /* ÊèõË£ùÊ†ºÂ≠ê */
        .wardrobe-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .skin-card {
            background: white; border-radius: 20px; padding: 15px; text-align: center;
            border: 3px solid transparent; transition: 0.2s; cursor: pointer;
            box-shadow: 0 5px 10px rgba(0,0,0,0.05);
        }
        .skin-card.active { border-color: #ff80ab; background: #fff0f5; }
        .skin-icon { font-size: 3rem; margin-bottom: 5px; }
        
        /* ÊØèÊó•Á¶ÆÁâ© */
        #daily-gift-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 6000;
            display: none; justify-content: center; align-items: center;
        }
        .gift-box {
            font-size: 6rem; animation: giftShake 1s infinite; cursor: pointer;
            filter: drop-shadow(0 0 20px rgba(255,255,255,0.8));
        }
        @keyframes giftShake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-10deg); } 75% { transform: rotate(10deg); } }

        /* ÁçéÂãµÂ±ïÁ§∫ */
        #reward-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 5000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .reward-content { position: relative; text-align: center; animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        @keyframes bounceIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        .light-rays {
            position: absolute; top: 50%; left: 50%; width: 500px; height: 500px;
            background: repeating-conic-gradient(from 0deg, rgba(255,255,255,0.1) 0deg 10deg, transparent 10deg 20deg);
            transform: translate(-50%, -50%); z-index: -1;
            animation: spin 10s linear infinite;
        }
        @keyframes spin { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
        
        /* Â§±ÊïóÂΩàÁ™ó */
        #game-over-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 10000;
            display: flex; justify-content: center; align-items: center;
            display: none; backdrop-filter: blur(5px);
        }
        .modal-content { 
            background: white; padding: 30px; border-radius: 30px; text-align: center; 
            width: 80%; max-width: 300px; border: 6px solid #ffcdd2;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .btn-restart { 
            background: linear-gradient(135deg, #ff80ab, #ff4081); 
            color: white; border: none; padding: 12px 35px; 
            border-radius: 25px; font-weight: bold; margin-top: 15px; 
            font-size: 1.1rem; box-shadow: 0 5px 15px rgba(255, 64, 129, 0.4);
        }

        /* ÁâπÊïàÊñáÂ≠ó */
        .float-text { position: absolute; font-family: 'Fredoka'; font-weight: 900; color: #ff4081; font-size: 1.8rem; pointer-events: none; z-index: 5000; animation: floatUp 1s forwards; text-shadow: 3px 3px 0 white; }
        @keyframes floatUp { 0% { transform:translateY(0) scale(1); opacity:1; } 100% { transform:translateY(-80px) scale(1.2); opacity:0; } }
        
        .combo-text {
            position: absolute; left: 50%; top: 30%; transform: translate(-50%, -50%);
            font-family: 'Fredoka'; font-weight: 900; font-size: 4rem;
            background: linear-gradient(to bottom, #ffeb3b, #ff9800);
            -webkit-background-clip: text; color: transparent;
            text-shadow: 0 5px 0 rgba(0,0,0,0.1);
            pointer-events: none; z-index: 6000;
            animation: popCombo 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes popCombo { 0% { transform: translate(-50%, -50%) scale(0); } 50% { transform: translate(-50%, -50%) scale(1.2); } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } }

        .bubble { position: absolute; top: 100px; left: 20px; background: white; padding: 8px 15px; border-radius: 20px; border-bottom-left-radius: 2px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); font-size: 0.9rem; color: #880e4f; font-weight: bold; opacity: 0; transition: 0.3s; pointer-events: none; }
        .bubble.show { opacity: 1; transform: translateY(-5px); }
    </style>
</head>
<body>

<div class="bg-blob blob-1"></div>
<div class="bg-blob blob-2"></div>

<div id="app-container">
    <div class="header-bar">
        <div class="pet-section">
            <div class="koala-wrapper" onclick="petKoala()">
                <svg id="koala-svg" viewBox="0 0 100 100">
                    <!-- Ë∫´È´î -->
                    <circle cx="50" cy="50" r="45" fill="#eceff1"/>
                    <circle cx="20" cy="30" r="15" fill="#cfd8dc"/> <circle cx="80" cy="30" r="15" fill="#cfd8dc"/>
                    <g id="eyes"><circle cx="35" cy="45" r="5" fill="#455a64"/><circle cx="65" cy="45" r="5" fill="#455a64"/></g>
                    <ellipse cx="50" cy="55" rx="10" ry="7" fill="#455a64"/>
                    <circle cx="25" cy="60" r="6" fill="rgba(255,128,171,0.4)"/> <circle cx="75" cy="60" r="6" fill="rgba(255,128,171,0.4)"/>
                    
                    <!-- È£æÂìÅÂ±§ (È†êË®≠Èö±Ëóè) -->
                    <g id="acc-bow" style="display:none"><path d="M30 20 L50 30 L70 20 L50 40 Z" fill="#ff4081"/><circle cx="50" cy="30" r="5" fill="#f50057"/></g>
                    <g id="acc-glasses" style="display:none"><rect x="25" y="40" width="20" height="10" rx="2" fill="#333"/><rect x="55" y="40" width="20" height="10" rx="2" fill="#333"/><line x1="45" y1="45" x2="55" y2="45" stroke="#333" stroke-width="2"/></g>
                    <g id="acc-crown" style="display:none"><path d="M30 25 L40 10 L50 25 L60 10 L70 25 L70 30 L30 30 Z" fill="#ffd700"/></g>
                </svg>
            </div>
            <div class="status-box">
                <div class="hunger-track"><div class="hunger-fill" id="hunger-bar"></div></div>
                <button class="feed-btn" onclick="feed()">È§µÈ£ü</button>
            </div>
        </div>
        <div class="menu-section">
            <div class="score-pill">üåø <span id="score">0</span></div>
            <div class="nav-btn btn-shop" onclick="openModal('shop')"><i class="fas fa-gift"></i></div>
            <div class="nav-btn btn-wardrobe" onclick="openModal('wardrobe')"><i class="fas fa-tshirt"></i></div>
        </div>
    </div>
    
    <div class="bubble" id="msg">‰∏ª‰∫∫ÔΩû</div>

    <div class="game-area">
        <div id="board-container">
            <canvas id="game-canvas" width="800" height="800"></canvas>
        </div>
    </div>
    
    <div id="spawn-area"></div>
</div>

<!-- ÂïÜÂ∫ó -->
<div id="shop-overlay" class="overlay">
    <div class="modal-header">
        <h1 class="modal-title">Ë®±È°òÊ∏ÖÂñÆ ‚ú®</h1>
        <div class="close-btn" onclick="closeModal('shop')"><i class="fas fa-times"></i></div>
    </div>
    <div id="shop-list"></div>
</div>

<!-- Ë°£Ê´É -->
<div id="wardrobe-overlay" class="overlay">
    <div class="modal-header">
        <h1 class="modal-title">ÁÑ°Â∞æÁÜäË°£Ê´É üëó</h1>
        <div class="close-btn" onclick="closeModal('wardrobe')"><i class="fas fa-times"></i></div>
    </div>
    <div class="wardrobe-grid" id="wardrobe-list"></div>
</div>

<!-- ÊØèÊó•Á¶ÆÁâ© -->
<div id="daily-gift-modal">
    <div style="text-align:center;">
        <div style="color:white; font-size:1.5rem; margin-bottom:20px; font-weight:bold;">ÊØèÊó•È©öÂñúÔºÅ</div>
        <div class="gift-box" onclick="openDailyGift()">üéÅ</div>
        <div style="color:white; margin-top:10px;">ÈªûÊìäÈñãÂïü</div>
    </div>
</div>

<!-- ÁçéÂãµÂ±ïÁ§∫ -->
<div id="reward-modal" onclick="this.style.display='none'">
    <div class="reward-content">
        <div class="light-rays"></div>
        <div class="reward-icon" id="reward-icon" style="font-size:6rem;">üéÅ</div>
        <div class="reward-title">Áç≤ÂæóÁçéÂãµÔºÅ</div>
        <div class="reward-name" id="reward-name" style="font-size:2rem; background:white; padding:5px 20px; border-radius:20px; color:#ff80ab; font-weight:900;">Á•ûÁßòÁ¶ÆÁâ©</div>
    </div>
</div>

<!-- Â§±ÊïóÂΩàÁ™ó -->
<div id="game-over-modal">
    <div class="modal-content">
        <div style="font-size:4rem;">üò≠</div>
        <h2 style="color:#880e4f; margin:10px 0;">Ê≤íÂú∞ÊñπÊîæ‰∫Ü</h2>
        <p style="color:#888;">ÁÑ°Â∞æÁÜäË¶∫ÂæóÂ•ΩÂèØÊÉú...</p>
        <button class="btn-restart" onclick="game.reset()">ÂÜçÁé©‰∏ÄÊ¨°</button>
    </div>
</div>

<script>
    /* === Á≤íÂ≠êÁâπÊïà === */
    const particles = [];
    class Particle {
        constructor(x, y, color, type = 'circle') {
            this.x = x; this.y = y; this.color = color;
            this.size = Math.random() * 12 + 4;
            this.speedX = Math.random() * 8 - 4; this.speedY = Math.random() * 8 - 4;
            this.life = 1.0; this.type = type;
        }
        update() { this.x += this.speedX; this.y += this.speedY; this.life -= 0.02; this.size *= 0.95; }
        draw(ctx) {
            ctx.globalAlpha = this.life; ctx.fillStyle = this.color;
            ctx.beginPath(); 
            if(this.type === 'rect') ctx.rect(this.x, this.y, this.size, this.size);
            else ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); 
            ctx.fill(); ctx.globalAlpha = 1.0;
        }
    }
    function createExplosion(x, y, color) { for(let i=0; i<12; i++) particles.push(new Particle(x, y, color)); }
    function createDust(x, y) { for(let i=0; i<5; i++) particles.push(new Particle(x, y, '#fff', 'rect')); }

    /* === Êï∏ÊìöËàáÁ≥ªÁµ± === */
    let coins = parseInt(localStorage.getItem('xr_coins') || 0);
    let hunger = parseInt(localStorage.getItem('xr_hunger') || 50);
    let ownedSkins = JSON.parse(localStorage.getItem('xr_skins') || '[]');
    let currentSkin = localStorage.getItem('xr_current_skin') || 'none';
    
    // Êï∏Â≠óÊªæÂãïÂãïÁï´
    let displayCoins = coins;
    function updateUI() {
        const scoreEl = document.getElementById('score');
        const target = coins;
        const step = () => {
            if(displayCoins < target) { displayCoins += Math.ceil((target - displayCoins)/5); if(displayCoins>target) displayCoins=target; }
            else if(displayCoins > target) { displayCoins -= Math.ceil((displayCoins - target)/5); if(displayCoins<target) displayCoins=target; }
            scoreEl.innerText = displayCoins;
            if(displayCoins !== target) requestAnimationFrame(step);
        };
        step();
        
        document.getElementById('hunger-bar').style.width = hunger + '%';
        localStorage.setItem('xr_coins', coins); localStorage.setItem('xr_hunger', hunger);
        
        // Êõ¥Êñ∞ÁÑ°Â∞æÁÜäÂ§ñËßÄ
        ['acc-bow', 'acc-glasses', 'acc-crown'].forEach(id => document.getElementById(id).style.display = 'none');
        if(currentSkin !== 'none') document.getElementById('acc-' + currentSkin).style.display = 'block';
    }

    /* === ÊØèÊó•Á¶ÆÁâ© === */
    function checkDaily() {
        const last = localStorage.getItem('xr_daily_date');
        const today = new Date().toDateString();
        if(last !== today) {
            document.getElementById('daily-gift-modal').style.display = 'flex';
        }
    }
    function openDailyGift() {
        const reward = Math.floor(Math.random() * 500) + 200;
        coins += reward; 
        localStorage.setItem('xr_daily_date', new Date().toDateString());
        document.getElementById('daily-gift-modal').style.display = 'none';
        updateUI();
        showReward(`+${reward} ËëâÂ≠ê`, 'üéÅ');
    }
    setTimeout(checkDaily, 1000);

    /* === ÂïÜÂ∫óËàáË°£Ê´É === */
    const PRIZES = [
        {n:'ÊâãÊêñÈ£≤', p:8000, icon:'üßã'}, {n:'ËÇ©È†∏ÊåâÊë©', p:30000, icon:'üíÜ‚Äç‚ôÄÔ∏è'}, 
        {n:'Â§ßÈ§ê', p:88000, icon:'üçΩÔ∏è'}, {n:'Ê∏ÖÁ©∫Ë≥ºÁâ©Ëªä', p:9999999, icon:'üõçÔ∏è'}
    ];
    const SKINS = [
        {id:'bow', n:'Á≤âÁ¥ÖËù¥Ëù∂Áµê', p:2000, icon:'üéÄ'},
        {id:'glasses', n:'ÈÖ∑ÈÖ∑Â¢®Èè°', p:5000, icon:'üï∂Ô∏è'},
        {id:'crown', n:'Â•≥ÁéãÁöáÂÜ†', p:10000, icon:'üëë'}
    ];

    function openModal(type) {
        document.getElementById(type+'-overlay').style.display = 'flex';
        const container = document.getElementById(type+'-list'); container.innerHTML = '';
        
        if(type === 'shop') {
            PRIZES.forEach(p => {
                container.innerHTML += `<div class="shop-item">
                    <div style="display:flex; align-items:center;">
                        <span style="font-size:2rem; margin-right:10px;">${p.icon}</span>
                        <div><b>${p.n}</b><br><small style="color:#ff80ab;">${p.p.toLocaleString()} üåø</small></div>
                    </div>
                    <button onclick="buyPrize('${p.n}',${p.p},'${p.icon}')" style="background:#8c9eff; color:white; border:none; padding:8px 15px; border-radius:15px;">ÂÖåÊèõ</button>
                </div>`;
            });
        } else {
            // È†êË®≠ÁÑ°Ë£ùÈ£æ
            container.innerHTML += `<div class="skin-card ${currentSkin==='none'?'active':''}" onclick="wearSkin('none')">
                <div class="skin-icon">üê®</div><div>ÂéüÂë≥</div>
            </div>`;
            
            SKINS.forEach(s => {
                const owned = ownedSkins.includes(s.id);
                container.innerHTML += `<div class="skin-card ${currentSkin===s.id?'active':''}" onclick="${owned ? `wearSkin('${s.id}')` : `buySkin('${s.id}', ${s.p}, '${s.n}')`}">
                    <div class="skin-icon">${s.icon}</div>
                    <div>${s.n}</div>
                    ${!owned ? `<small style="color:#ff80ab">${s.p}</small>` : '<small style="color:#aaa">Â∑≤ÊìÅÊúâ</small>'}
                </div>`;
            });
        }
    }
    function closeModal(type) { document.getElementById(type+'-overlay').style.display = 'none'; }

    function buyPrize(n, p, icon) {
        if(coins>=p) { coins-=p; updateUI(); closeModal('shop'); showReward(n, icon); }
        else alert("ËëâÂ≠ê‰∏çÂ§†ÂñîÔºÅ");
    }
    function buySkin(id, p, name) {
        if(coins>=p) {
            coins-=p; ownedSkins.push(id);
            localStorage.setItem('xr_skins', JSON.stringify(ownedSkins));
            updateUI(); openModal('wardrobe'); // Âà∑Êñ∞‰ªãÈù¢
            alert(`Ë≤∑Âà∞‰∫Ü ${name}ÔºÅ`);
        } else alert("ËëâÂ≠ê‰∏çÂ§†ÂñîÔºÅ");
    }
    function wearSkin(id) {
        currentSkin = id;
        localStorage.setItem('xr_current_skin', currentSkin);
        updateUI(); openModal('wardrobe');
    }

    function showReward(name, icon) {
        document.getElementById('reward-name').innerText = name;
        document.getElementById('reward-icon').innerText = icon;
        document.getElementById('reward-modal').style.display = 'flex';
        for(let i=0; i<5; i++) setTimeout(()=>createExplosion(window.innerWidth/2, window.innerHeight/2, ['#ffeb3b','#ff4081','#00e5ff'][i%3]), i*200);
    }

    function feed() {
        if(coins >= 50) {
            if(hunger>=100) return speak("È£Ω‰∫ÜÔºÅ");
            coins -= 50; hunger = Math.min(100, hunger+20);
            updateUI(); speak("Â•ΩÂêÉÔºÅ");
            createExplosion(100, 100, '#ff4081');
        } else speak("Ê≤íÈå¢...");
    }
    function speak(text) {
        const b = document.getElementById('msg'); b.innerText = text;
        b.classList.add('show'); setTimeout(()=>b.classList.remove('show'), 2000);
    }
    let clicks=0; function petKoala(){ clicks++; if(clicks===10){coins+=10000;updateUI();alert("Áî∑ÂèãÊïëÊòü+10000");clicks=0;} else speak("ÊÑõÂ¶≥ ‚ù§Ô∏è"); }

    /* === ÈÅäÊà≤ÂºïÊìé === */
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const SHAPES = [
        {m:[[1]], c:'#ff8a80'}, {m:[[1,1]], c:'#ff80ab'}, {m:[[1],[1]], c:'#ea80fc'},
        {m:[[1,1,1]], c:'#b388ff'}, {m:[[1,1],[1,1]], c:'#8c9eff'}, {m:[[1,1,1],[0,1,0]], c:'#80d8ff'}
    ];
    let grid = Array(8).fill().map(()=>Array(8).fill(0));
    let currentDrag = null; let ghost = null;
    const CELL = 100;
    let flashLines = []; let comboCount = 0;

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const Sound = { play: (f,t,d)=>{if(audioCtx.state==='suspended')audioCtx.resume();const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type=t;o.frequency.setValueAtTime(f,audioCtx.currentTime);g.gain.setValueAtTime(0.05,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+d);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+d);}, drop: ()=>Sound.play(300,'triangle',0.1), fail: ()=>Sound.play(150,'sawtooth',0.5) };

    function draw() {
        ctx.clearRect(0,0,800,800);
        for(let i=particles.length-1; i>=0; i--) {
            particles[i].update(); particles[i].draw(ctx);
            if(particles[i].life <= 0) particles.splice(i, 1);
        }
        ctx.strokeStyle = '#fce4ec'; ctx.lineWidth=3; ctx.setLineDash([10, 10]);
        for(let i=0;i<=8;i++) {
            ctx.beginPath(); ctx.moveTo(0,i*CELL); ctx.lineTo(800,i*CELL); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(i*CELL,0); ctx.lineTo(i*CELL,800); ctx.stroke();
        }
        ctx.setLineDash([]);
        if(ghost) drawShape(ghost.shape, ghost.x, ghost.y, 'rgba(0,0,0,0.1)');
        for(let y=0;y<8;y++) for(let x=0;x<8;x++) if(grid[y][x]) drawCell(x,y,grid[y][x]);

        if(flashLines.length > 0) {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            flashLines.forEach(f => {
                if(f.type === 'row') ctx.fillRect(0, f.index*CELL, 800, CELL);
                else ctx.fillRect(f.index*CELL, 0, CELL, 800);
                f.life -= 0.1;
            });
            flashLines = flashLines.filter(f => f.life > 0);
        }
        requestAnimationFrame(draw);
    }
    
    function drawCell(x,y,c) {
        let p=6, s=CELL-p*2;
        ctx.fillStyle=c; ctx.beginPath(); ctx.roundRect(x*CELL+p, y*CELL+p, s, s, 20); ctx.fill();
        ctx.fillStyle = 'rgba(255,255,255,0.4)'; ctx.beginPath(); ctx.arc(x*CELL+p+15, y*CELL+p+15, 8, 0, Math.PI*2); ctx.fill();
    }
    function drawShape(s,x,y,c) { for(let r=0;r<s.m.length;r++) for(let c2=0;c2<s.m[0].length;c2++) if(s.m[r][c2]) drawCell(x+c2, y+r, c || s.c); }

    function spawn() {
        const area = document.getElementById('spawn-area'); area.innerHTML = '';
        for(let i=0;i<3;i++) {
            const data = SHAPES[Math.floor(Math.random()*SHAPES.length)];
            const el = document.createElement('canvas');
            el.width=60; el.height=60; el.className='shape-preview'; el.shapeData = data; 
            const c = el.getContext('2d');
            const s=12, ox=(60-data.m[0].length*s)/2, oy=(60-data.m.length*s)/2;
            c.fillStyle=data.c;
            for(let r=0;r<data.m.length;r++) for(let col=0;col<data.m[0].length;col++) if(data.m[r][col]) { c.beginPath(); c.roundRect(ox+col*s, oy+r*s, s-1, s-1, 3); c.fill(); }
            el.addEventListener('touchstart', (e)=>startDrag(e, el, data), {passive:false});
            el.addEventListener('mousedown', (e)=>startDrag(e, el, data));
            area.appendChild(el);
        }
        checkOver();
    }

    function startDrag(e, el, data) { e.preventDefault(); currentDrag = { el, data }; el.classList.add('dragging'); moveDrag(e); }
    function moveDrag(e) {
        if(!currentDrag) return;
        const evt = e.touches ? e.touches[0] : e;
        const el = currentDrag.el;
        const offset = 80; const elWidth = 60;
        el.style.left = (evt.clientX - elWidth/2) + 'px'; el.style.top = (evt.clientY - elWidth/2 - offset) + 'px';
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width; const scaleY = canvas.height / rect.height;
        const canvasX = (evt.clientX - rect.left) * scaleX; const canvasY = (evt.clientY - offset - rect.top) * scaleY;
        const gx = Math.floor(canvasX / CELL); const gy = Math.floor(canvasY / CELL);
        const shape = currentDrag.data;
        const px = gx - Math.floor(shape.m[0].length/2); const py = gy - Math.floor(shape.m.length/2);
        let best = null; let minDistance = Infinity;
        for(let dy=-2; dy<=2; dy++) for(let dx=-2; dx<=2; dx++) {
            const tx = px + dx; const ty = py + dy;
            if(canPlace(shape.m, tx, ty)) {
                const dist = Math.sqrt(dx*dx + dy*dy);
                if(dist < minDistance) { minDistance = dist; best = {x: tx, y: ty}; }
            }
        }
        ghost = best ? {x:best.x, y:best.y, shape:shape} : null;
    }
    function endDrag() {
        if(!currentDrag) return;
        if(ghost) { place(ghost.shape, ghost.x, ghost.y); currentDrag.el.remove(); Sound.drop(); if(document.getElementById('spawn-area').children.length===0) setTimeout(spawn, 300); else checkOver(); }
        else { currentDrag.el.classList.remove('dragging'); currentDrag.el.style.left=''; currentDrag.el.style.top=''; }
        currentDrag = null; ghost = null;
    }
    document.addEventListener('touchmove', moveDrag, {passive:false}); document.addEventListener('mousemove', moveDrag);
    document.addEventListener('touchend', endDrag); document.addEventListener('mouseup', endDrag);

    function canPlace(m, x, y) { for(let r=0;r<m.length;r++) for(let c=0;c<m[0].length;c++) if(m[r][c]) { let nx=x+c, ny=y+r; if(nx<0||nx>=8||ny<0||ny>=8||grid[ny][nx]) return false; } return true; }
    function place(s, x, y) { for(let r=0;r<s.m.length;r++) for(let c=0;c<s.m[0].length;c++) if(s.m[r][c]) { grid[y+r][x+c] = s.c; createDust((x+c)*CELL+CELL/2, (y+r)*CELL+CELL); } checkLines(); }
    
    function checkLines() {
        let lines = 0; let clearedCells = [];
        for(let y=0;y<8;y++) if(grid[y].every(c=>c)) { grid[y].fill(0); lines++; flashLines.push({type:'row', index:y, life:1.0}); for(let x=0; x<8; x++) clearedCells.push({x, y}); }
        for(let x=0;x<8;x++) { let full=true; for(let y=0;y<8;y++) if(!grid[y][x]) full=false; if(full) { for(let y=0;y<8;y++) { grid[y][x]=0; clearedCells.push({x, y}); } lines++; flashLines.push({type:'col', index:x, life:1.0}); } }
        
        if(lines>0) {
            comboCount++;
            let bonus = lines * 10 * comboCount; coins += bonus; updateUI();
            
            const f = document.createElement('div'); f.className='float-text'; f.innerText=`+${bonus}`;
            f.style.left='50%'; f.style.top='50%'; document.body.appendChild(f); setTimeout(()=>f.remove(),800);
            
            if(comboCount > 1) {
                const c = document.createElement('div'); c.className='combo-text'; c.innerText=`COMBO x${comboCount}!`;
                document.body.appendChild(c); setTimeout(()=>c.remove(), 800);
                document.getElementById('board-container').classList.add('shake-hard');
                setTimeout(()=>document.getElementById('board-container').classList.remove('shake-hard'), 400);
                document.body.classList.add('fever-mode');
            }
            
            clearedCells.forEach(cell => { createExplosion(cell.x*CELL + CELL/2, cell.y*CELL + CELL/2, '#ff4081'); createExplosion(cell.x*CELL + CELL/2, cell.y*CELL + CELL/2, '#8c9eff'); });
        } else { comboCount = 0; document.body.classList.remove('fever-mode'); }
    }

    function checkOver() {
        setTimeout(() => {
            const els = document.querySelectorAll('#spawn-area .shape-preview');
            if (els.length === 0) return;
            let canMove = false;
            for (let i = 0; i < els.length; i++) {
                const shape = els[i].shapeData;
                for (let y = 0; y < 8; y++) { for (let x = 0; x < 8; x++) { if (canPlace(shape.m, x, y)) { canMove = true; break; } } if (canMove) break; }
                if (canMove) break;
            }
            if (!canMove) { Sound.fail(); document.getElementById('board-container').classList.add('board-shake'); setTimeout(() => { document.getElementById('game-over-modal').style.display = 'flex'; }, 800); }
        }, 200);
    }
    const game = { reset: function() { grid = Array(8).fill().map(()=>Array(8).fill(0)); document.getElementById('game-over-modal').style.display='none'; document.getElementById('board-container').classList.remove('board-shake'); comboCount=0; spawn(); } };
    updateUI(); draw(); spawn();
</script>
</body>
</html>
