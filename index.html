<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>ç„¡å°¾ç†Šè¨±é¡˜æ±  ğŸ¨ğŸ’¸</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="theme-color" content="#ffcdd2">
    
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Varela+Round&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-gradient: linear-gradient(180deg, #fff0f5 0%, #ffebee 100%);
            --text-main: #880e4f;
            --accent: #ff80ab;
            --accent-dark: #c51162;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            background: var(--bg-gradient);
            font-family: 'Varela Round', sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex; flex-direction: column;
            color: var(--text-main);
        }

        /* === 1. é ‚éƒ¨é¤Šæˆå€ === */
        .pet-area {
            width: 100%; height: 160px;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            position: relative; z-index: 10;
            padding-bottom: 5px;
            background: radial-gradient(circle at center bottom, rgba(255,255,255,0.6) 0%, transparent 70%);
            flex-shrink: 0;
        }

        .speech-bubble {
            background: white; padding: 8px 15px; border-radius: 15px;
            position: absolute; top: 10px;
            box-shadow: 0 3px 10px rgba(233,30,99,0.1);
            font-size: 0.8rem; color: #880e4f; font-weight: bold;
            transform: scale(0); transition: transform 0.3s;
            border: 2px solid #ffcdd2; pointer-events: none;
        }
        .speech-bubble.show { transform: scale(1); }

        #koala-svg {
            width: 80px; height: 70px;
            filter: drop-shadow(0 3px 5px rgba(233,30,99,0.1));
            cursor: pointer; transition: transform 0.1s; z-index: 2;
        }
        #koala-svg:active { transform: scale(0.9); }
        
        .status-bar {
            width: 100px; height: 8px; background: #ffcdd2;
            border-radius: 10px; margin-top: 5px; overflow: hidden; border: 2px solid #fff;
        }
        .status-fill {
            height: 100%; background: linear-gradient(90deg, #ff80ab, #ff4081);
            width: 50%; transition: width 0.5s;
        }

        .feed-btn {
            position: absolute; right: 20px; bottom: 20px;
            background: white; width: 40px; height: 40px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem; box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            cursor: pointer; border: 2px solid #ff80ab; color: #ff80ab;
        }
        .feed-btn:active { transform: scale(0.9); background: #ff80ab; color: white; }

        /* === 2. å°èˆªåˆ— === */
        .nav-bar {
            position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95); 
            padding: 5px 20px; border-radius: 40px;
            display: flex; gap: 30px; 
            box-shadow: 0 5px 20px rgba(255, 128, 171, 0.25);
            border: 3px solid #fff; z-index: 1000;
        }
        .nav-item {
            font-size: 1.2rem; color: #ffcdd2; cursor: pointer; transition: 0.3s;
            width: 45px; height: 45px; display: flex; justify-content: center; align-items: center;
            border-radius: 50%; background: #fff;
        }
        .nav-item.active { 
            background: var(--accent); color: white; 
            transform: translateY(-10px) scale(1.1); 
            box-shadow: 0 4px 0 var(--accent-dark);
        }

        /* === 3. é é¢åˆ‡æ› === */
        .page {
            position: absolute; top: 160px; left: 0; width: 100%; bottom: 80px;
            display: flex; flex-direction: column; align-items: center;
            transition: opacity 0.3s; opacity: 0; pointer-events: none;
        }
        .page.active { opacity: 1; pointer-events: all; }

        /* === 4. éŠæˆ²å€ === */
        #game-wrapper { 
            width: 100%; height: 100%; padding: 0 15px; 
            display: flex; flex-direction: column; justify-content: center;
        }
        .game-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 5px; 
        }
        .score-bubble {
            background: white; padding: 3px 12px; border-radius: 15px; font-size: 0.9rem;
            border: 2px solid #ffcdd2; color: var(--accent-dark); font-weight: bold;
        }
        
        #board-container {
            width: 100%; max-width: 360px;
            aspect-ratio: 1/1; background: #fff;
            border-radius: 20px; padding: 8px; margin: 0 auto;
            box-shadow: 0 5px 0 #f8bbd0; border: 4px solid #ffebee;
            transition: filter 0.3s;
        }
        .board-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        canvas#game-canvas { width: 100%; height: 100%; border-radius: 12px; display: block; }
        
        #spawn-area { 
            width: 100%; height: 100px; 
            display: flex; justify-content: space-around; align-items: center; 
            margin-top: 5px;
        }
        .shape-preview { width: 60px; height: 60px; }
        .shape-preview.dragging { opacity: 0.8; z-index: 2000; position: fixed; transform: scale(1.2); pointer-events: none; }

        /* === å•†åº—å€ === */
        #shop-wrapper { width: 100%; height: 100%; padding: 10px 20px; overflow-y: auto; }
        .wallet-card {
            background: linear-gradient(135deg, #ff80ab, #ff4081); color: white;
            padding: 15px; border-radius: 20px; margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 5px 15px rgba(255, 64, 129, 0.3);
        }
        .coupon-item {
            background: white; border-radius: 15px; padding: 10px 15px; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 3px 0 #fce4ec; border: 2px solid #fff;
        }
        .btn-redeem {
            background: var(--accent); color: white; border: none; padding: 6px 12px;
            border-radius: 15px; font-weight: bold; cursor: pointer; font-size: 0.9rem;
        }
        .btn-redeem:disabled { background: #eee; color: #aaa; }

        /* === å¤±æ•—å½ˆçª— === */
        #game-over-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 5000;
            display: flex; justify-content: center; align-items: center;
            display: none; backdrop-filter: blur(3px);
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 30px;
            text-align: center; width: 80%; max-width: 300px;
            border: 5px solid #ffcdd2;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .btn-restart {
            background: linear-gradient(135deg, #ff80ab, #ff4081);
            color: white; border: none; padding: 12px 30px;
            border-radius: 25px; font-weight: bold; font-size: 1.1rem;
            margin-top: 15px; cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 64, 129, 0.4);
        }

        /* === å‹•ç•« === */
        .eye { transform-origin: center; }
        .mouth { transition: d 0.3s; }
        .koala-chew .mouth { animation: chew 0.5s infinite; }
        @keyframes chew { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(0.5); } }
        
        .float-text {
            position: absolute; font-family: 'Fredoka'; font-weight: 900;
            color: #ff4081; font-size: 1.5rem; pointer-events: none;
            text-shadow: 2px 2px 0px white; z-index: 3000;
            animation: floatUp 1s forwards;
        }
        @keyframes floatUp { 0% { transform:translateY(0); opacity:0; } 50% { opacity:1; } 100% { transform:translateY(-50px); opacity:0; } }
    </style>
</head>
<body>

<!-- 1. é¤Šæˆå€ -->
<div class="pet-area">
    <div class="speech-bubble" id="bubble">ä¸»äººï¼Œæˆ‘è‚šå­é¤“äº†...</div>
    
    <div id="koala-container" onclick="petKoala()">
        <svg id="koala-svg" viewBox="0 0 100 80">
            <ellipse cx="50" cy="80" rx="35" ry="25" fill="#cfd8dc"/>
            <circle cx="15" cy="25" r="12" fill="#cfd8dc"/>
            <circle cx="85" cy="25" r="12" fill="#cfd8dc"/>
            <circle cx="15" cy="25" r="7" fill="#ffcdd2"/>
            <circle cx="85" cy="25" r="7" fill="#ffcdd2"/>
            <circle cx="50" cy="40" r="35" fill="#eceff1"/>
            <g id="eyes-normal"><circle cx="35" cy="38" r="4" fill="#455a64"/><circle cx="65" cy="38" r="4" fill="#455a64"/></g>
            <g id="eyes-happy" style="display:none"><path d="M31 38 Q35 34 39 38" stroke="#455a64" stroke-width="3" fill="none"/><path d="M61 38 Q65 34 69 38" stroke="#455a64" stroke-width="3" fill="none"/></g>
            <g id="eyes-sad" style="display:none"><path d="M31 40 Q35 36 39 40" stroke="#455a64" stroke-width="3" fill="none"/><path d="M61 40 Q65 36 69 40" stroke="#455a64" stroke-width="3" fill="none"/><circle cx="30" cy="45" r="2" fill="#4fc3f7"/></g>
            <ellipse cx="50" cy="48" rx="9" ry="6" fill="#455a64"/>
            <path class="mouth" d="M45 58 Q50 62 55 58" stroke="#455a64" stroke-width="2" fill="none" stroke-linecap="round"/>
            <circle cx="25" cy="50" r="6" fill="rgba(255,128,171,0.4)"/><circle cx="75" cy="50" r="6" fill="rgba(255,128,171,0.4)"/>
        </svg>
    </div>

    <div class="status-bar"><div class="status-fill" id="hunger-bar" style="width: 50%;"></div></div>
    <div class="feed-btn" onclick="feedKoala()"><i class="fas fa-leaf"></i></div>
</div>

<!-- å°èˆª -->
<div class="nav-bar">
    <div class="nav-item active" onclick="switchPage('game')"><i class="fas fa-gamepad"></i></div>
    <div class="nav-item" onclick="switchPage('shop')"><i class="fas fa-gift"></i></div>
</div>

<!-- éŠæˆ²é é¢ -->
<div id="game-page" class="page active">
    <div id="game-wrapper">
        <div class="game-header">
            <div style="font-weight:bold; color:#ec407a; font-size:0.9rem;">æ‹¼åœ–è³ºè‘‰å­</div>
            <div class="score-bubble">ğŸŒ¿ <span id="game-coins">0</span></div>
        </div>
        <div id="board-container">
            <canvas id="game-canvas" width="800" height="800"></canvas>
        </div>
        <div id="spawn-area"></div>
    </div>
</div>

<!-- å•†åº—é é¢ -->
<div id="shop-page" class="page">
    <div id="shop-wrapper">
        <div class="wallet-card">
            <div>
                <div style="font-size:0.8rem; opacity:0.9;">æˆ‘çš„è‘‰å­</div>
                <div style="font-size:2rem; font-weight:900; font-family:'Fredoka';" id="total-coins">0</div>
            </div>
            <i class="fas fa-leaf" style="font-size:2.5rem; opacity:0.5;"></i>
        </div>
        <div id="shop-container"></div>
    </div>
</div>

<!-- å¤±æ•—å½ˆçª— -->
<div id="game-over-modal">
    <div class="modal-content">
        <div style="font-size:3rem;">ğŸ˜­</div>
        <h2 style="color:#880e4f; margin:10px 0;">å“å‘€ï¼æ²’åœ°æ–¹æ”¾äº†</h2>
        <p style="color:#666; font-size:0.9rem; margin-bottom:10px;">ç„¡å°¾ç†Šè¦ºå¾—å¥½å¯æƒœ...</p>
        <p style="color:#ff80ab; font-weight:bold;">ä½†è‘‰å­éƒ½æœ‰ä¿ç•™å–”ï¼</p>
        <button class="btn-restart" onclick="game.reset()">å†ç©ä¸€æ¬¡</button>
    </div>
</div>

<div style="position:fixed; top:0; right:0; width:30px; height:30px; z-index:5000;" onclick="Admin.showLogs()"></div>

<script>
    /* 1. é¤Šæˆç³»çµ± */
    const Pet = {
        hunger: parseInt(localStorage.getItem('xr_pet_hunger') || 50),
        lastLogin: parseInt(localStorage.getItem('xr_pet_last_login') || Date.now()),
        messages: ["æƒ³æˆ‘äº†å—ï¼Ÿ", "è¨˜å¾—å–æ°´å–”ï¼", "ä¼‘æ¯ä¸€ä¸‹ï½", "å–œæ­¡å¦³ â¤ï¸", "åŠ æ²¹ï¼"],
        init: function() {
            const now = Date.now();
            const hoursPassed = (now - this.lastLogin) / (1000 * 60 * 60);
            if(hoursPassed > 1) this.hunger = Math.max(0, this.hunger - Math.floor(hoursPassed * 5));
            this.save(); this.updateUI();
            setInterval(() => { this.hunger = Math.max(0, this.hunger - 1); this.save(); this.updateUI(); }, 60000 * 10);
        },
        save: function() { localStorage.setItem('xr_pet_hunger', this.hunger); localStorage.setItem('xr_pet_last_login', Date.now()); },
        updateUI: function() {
            const bar = document.getElementById('hunger-bar'); bar.style.width = this.hunger + '%';
            document.getElementById('eyes-normal').style.display = 'none';
            document.getElementById('eyes-happy').style.display = 'none';
            document.getElementById('eyes-sad').style.display = 'none';
            if(this.hunger > 70) { document.getElementById('eyes-happy').style.display = 'block'; bar.style.background = '#69f0ae'; }
            else if (this.hunger < 30) { document.getElementById('eyes-sad').style.display = 'block'; bar.style.background = '#ff5252'; }
            else { document.getElementById('eyes-normal').style.display = 'block'; bar.style.background = 'linear-gradient(90deg, #ff80ab, #ff4081)'; }
        },
        speak: function(text) {
            const bubble = document.getElementById('bubble');
            bubble.innerText = text || this.messages[Math.floor(Math.random() * this.messages.length)];
            bubble.classList.add('show'); setTimeout(() => bubble.classList.remove('show'), 3000);
        },
        setMood: function(mood) {
            if(mood === 'sad') {
                document.getElementById('eyes-normal').style.display = 'none';
                document.getElementById('eyes-happy').style.display = 'none';
                document.getElementById('eyes-sad').style.display = 'block';
                this.speak("å—šå—š...æ²’åœ°æ–¹ä½äº†...");
            }
        }
    };

    let secretClicks = 0;
    function feedKoala() {
        if(userCoins >= 50) {
            if(Pet.hunger >= 100) { Pet.speak("åƒä¸ä¸‹äº†ï¼"); return; }
            userCoins -= 50; updateUI();
            Pet.hunger = Math.min(100, Pet.hunger + 10); Pet.save(); Pet.updateUI(); Pet.speak("å¥½åƒï¼è¬è¬ â¤ï¸");
            document.getElementById('koala-svg').classList.add('koala-chew');
            setTimeout(() => document.getElementById('koala-svg').classList.remove('koala-chew'), 1000);
            createHeart();
        } else { Pet.speak("è‘‰å­ä¸å¤ ..."); }
    }
    function petKoala() { 
        createHeart(); 
        secretClicks++;
        if(secretClicks === 10) {
            userCoins += 10000; updateUI();
            alert("ğŸ¨ ç”·å‹æ•‘æ˜Ÿå•Ÿå‹•ï¼\nå·²åŒ¯å…¥ 10,000 è‘‰å­ã€‚");
            secretClicks = 0;
        } else {
            Pet.speak(); 
        }
    }
    function createHeart() {
        const rect = document.getElementById('koala-svg').getBoundingClientRect();
        const heart = document.createElement('div'); heart.className = 'float-text'; heart.innerText = 'â¤ï¸';
        heart.style.left = (rect.left + rect.width/2) + 'px'; heart.style.top = rect.top + 'px';
        document.body.appendChild(heart); setTimeout(() => heart.remove(), 1000);
    }

    /* 2. å•†åº— (è¶…ç´šé€šè²¨è†¨è„¹ç‰ˆ) */
    const DreamloConfig = { privateKey: "", publicKey: "" };
    const REAL_PRIZES = [
        { id: 'tea', name: 'æ‰‹æ–é£²ä¸€æ¯', price: 8000, icon: 'ğŸ§‹' },
        { id: 'massage', name: 'è‚©é ¸æŒ‰æ‘© (20åˆ†)', price: 30000, icon: 'ğŸ’†â€â™€ï¸' },
        { id: 'food', name: 'è«‹åƒä¸€é “å¤§é¤', price: 88000, icon: 'ğŸ½ï¸' },
        { id: 'movie', name: 'é›»å½±ä¹‹å¤œ', price: 150000, icon: 'ğŸ¬' },
        { id: 'wish', name: 'ç„¡æ¢ä»¶é¡˜æœ›åˆ¸', price: 1000000, icon: 'ğŸ§â€â™‚ï¸' },
        { id: 'cart', name: 'æ¸…ç©ºè³¼ç‰©è»Š', price: 9999999, icon: 'ğŸ›ï¸' }
    ];
    let userCoins = parseInt(localStorage.getItem('xr_leaf_coins') || 0);
    function updateUI() {
        document.getElementById('total-coins').innerText = userCoins;
        document.getElementById('game-coins').innerText = userCoins;
        localStorage.setItem('xr_leaf_coins', userCoins);
        renderShop();
    }
    function renderShop() {
        const container = document.getElementById('shop-container'); container.innerHTML = '';
        REAL_PRIZES.forEach(item => {
            const canBuy = userCoins >= item.price;
            const div = document.createElement('div'); div.className = 'coupon-item';
            div.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <div style="font-size:1.5rem; margin-right:10px;">${item.icon}</div>
                    <div><div style="font-weight:bold; color:#555; font-size:0.9rem;">${item.name}</div><div style="color:#ff80ab; font-size:0.8rem;">${item.price.toLocaleString()}</div></div>
                </div>
                <button class="btn-redeem" ${canBuy ? '' : 'disabled'} onclick="redeemItem('${item.name}', ${item.price})">${canBuy ? 'å…Œæ›' : 'ä¸è¶³'}</button>`;
            container.appendChild(div);
        });
    }
    function redeemItem(itemName, price) {
        if(confirm(`å…Œæ›ã€Œ${itemName}ã€ï¼Ÿ`)) { userCoins -= price; updateUI(); Admin.uploadLog(itemName); alert(`å…Œæ›æˆåŠŸï¼\nç²å¾—ï¼š${itemName}`); }
    }

    /* 3. éŠæˆ²å¼•æ“ */
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const Sound = {
        play: (freq, type, dur) => {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.type = type; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
            g.gain.setValueAtTime(0.05, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
            o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + dur);
        },
        pickup: () => Sound.play(500, 'sine', 0.1), drop: () => Sound.play(300, 'triangle', 0.1), clear: (n) => { for(let i=0;i<n;i++) setTimeout(()=>Sound.play(500*(1+i*0.2),'sine',0.2), i*60); },
        fail: () => { Sound.play(150, 'sawtooth', 0.5); setTimeout(()=>Sound.play(100, 'sawtooth', 0.5), 400); }
    };

    const SHAPES = [
        { m: [[1]], color: '#ff8a80' }, { m: [[1,1]], color: '#ff80ab' }, { m: [[1],[1]], color: '#ea80fc' },
        { m: [[1,1,1]], color: '#b388ff' }, { m: [[1],[1],[1]], color: '#8c9eff' }, { m: [[1,1],[1,1]], color: '#82b1ff' },
        { m: [[1,1,1],[0,1,0]], color: '#80d8ff' }, { m: [[1,0],[1,0],[1,1]], color: '#84ffff' }, { m: [[1,1,1,1]], color: '#a7ffeb' }
    ];

    class BlockPuzzle {
        constructor() {
            this.canvas = document.getElementById('game-canvas');
            this.ctx = this.canvas.getContext('2d');
            this.gridSize = 8;
            this.cellSize = this.canvas.width / this.gridSize;
            this.grid = Array(this.gridSize).fill().map(() => Array(this.gridSize).fill(0));
            this.currentShape = null;
            this.ghostShape = null;
            this.TOUCH_OFFSET = 150;
            this.isGameOver = false;
            
            this.loop = this.loop.bind(this);
            requestAnimationFrame(this.loop);
            this.spawnShapes();
            updateUI();
            Pet.init();
        }
        loop() {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.drawGrid();
            if (!this.isGameOver && this.ghostShape) this.drawGhost();
            this.drawPlacedBlocks();
            requestAnimationFrame(this.loop);
        }
        drawGrid() {
            this.ctx.strokeStyle = '#ffebee'; this.ctx.lineWidth = 2;
            for(let i=0; i<=this.gridSize; i++) {
                let pos = i * this.cellSize;
                this.ctx.beginPath(); this.ctx.moveTo(0, pos); this.ctx.lineTo(800, pos); this.ctx.stroke();
                this.ctx.beginPath(); this.ctx.moveTo(pos, 0); this.ctx.lineTo(pos, 800); this.ctx.stroke();
            }
        }
        drawGhost() {
            const { x, y, shape } = this.ghostShape;
            this.ctx.save(); this.ctx.globalAlpha = 0.3;
            for(let r=0; r<shape.m.length; r++) {
                for(let c=0; c<shape.m[0].length; c++) {
                    if(shape.m[r][c]) this.drawCell(x + c, y + r, shape.color); 
                }
            }
            this.ctx.restore();
        }
        drawPlacedBlocks() {
            for(let r=0; r<this.gridSize; r++) {
                for(let c=0; c<this.gridSize; c++) {
                    if(this.grid[r][c] !== 0) {
                        this.drawCell(c, r, this.isGameOver ? '#ccc' : this.grid[r][c]);
                    }
                }
            }
        }
        drawCell(x, y, color) {
            const padding = 4; const size = this.cellSize - padding * 2;
            const cx = x * this.cellSize + this.cellSize/2; const cy = y * this.cellSize + this.cellSize/2;
            this.ctx.save(); this.ctx.translate(cx, cy);
            this.ctx.fillStyle = color;
            this.ctx.beginPath(); this.ctx.roundRect(-size/2, -size/2, size, size, 15); this.ctx.fill();
            this.ctx.fillStyle = 'rgba(255,255,255,0.3)';
            this.ctx.beginPath(); this.ctx.arc(-size/4, -size/4, size/5, 0, Math.PI*2); this.ctx.fill();
            this.ctx.restore();
        }
        spawnShapes() {
            const container = document.getElementById('spawn-area'); container.innerHTML = '';
            for(let i=0; i<3; i++) {
                const shapeData = SHAPES[Math.floor(Math.random() * SHAPES.length)];
                this.createDraggableShape(shapeData, container);
            }
            this.checkGameOver();
        }
        createDraggableShape(data, container) {
            const el = document.createElement('canvas');
            el.width = 60; el.height = 60; el.className = 'shape-preview';
            el.shapeData = data; 
            const ctx = el.getContext('2d');
            const rows = data.m.length; const cols = data.m[0].length;
            const size = 10; const offsetX = (60 - cols*size)/2; const offsetY = (60 - rows*size)/2;
            for(let r=0; r<rows; r++) {
                for(let c=0; c<cols; c++) {
                    if(data.m[r][c]) { 
                        ctx.fillStyle = data.color;
                        ctx.beginPath(); ctx.roundRect(offsetX + c*size, offsetY + r*size, size-1, size-1, 3); ctx.fill();
                    }
                }
            }
            const handleStart = (e) => {
                if(this.isGameOver) return;
                e.preventDefault(); Sound.pickup(); el.classList.add('dragging');
                this.currentShape = { el, data };
                this.moveShape(e);
            };
            el.addEventListener('mousedown', handleStart); el.addEventListener('touchstart', handleStart);
            container.appendChild(el);
        }
        moveShape(e) {
            const move = (ev) => {
                if(!this.currentShape) return;
                const cx = ev.clientX || ev.touches[0].clientX; const cy = ev.clientY || ev.touches[0].clientY;
                const el = this.currentShape.el;
                el.style.left = (cx - 30) + 'px'; el.style.top = (cy - 30 - this.TOUCH_OFFSET) + 'px';
                
                const rect = this.canvas.getBoundingClientRect();
                const x = (cx - rect.left) * (this.canvas.width / rect.width);
                const y = (cy - this.TOUCH_OFFSET - rect.top) * (this.canvas.height / rect.height);
                const gx = Math.floor(x / this.cellSize); const gy = Math.floor(y / this.cellSize);
                const shape = this.currentShape.data;
                const finalX = gx - Math.floor(shape.m[0].length/2); const finalY = gy - Math.floor(shape.m.length/2);
                
                if(this.canPlace(shape.m, finalX, finalY)) {
                    this.ghostShape = { x: finalX, y: finalY, shape: shape };
                } else { this.ghostShape = null; }
                this.currentShape.gx = finalX; this.currentShape.gy = finalY;
            };
            const end = (ev) => {
                document.removeEventListener('mousemove', move); document.removeEventListener('touchmove', move);
                document.removeEventListener('mouseup', end); document.removeEventListener('touchend', end);
                if(!this.currentShape) return;
                if(this.ghostShape) {
                    this.place(this.currentShape.data, this.ghostShape.x, this.ghostShape.y);
                    this.currentShape.el.remove(); Sound.drop();
                    if(document.getElementById('spawn-area').children.length === 0) setTimeout(() => this.spawnShapes(), 500);
                    else this.checkGameOver();
                } else {
                    this.currentShape.el.classList.remove('dragging');
                    this.currentShape.el.style.position = ''; this.currentShape.el.style.left = ''; this.currentShape.el.style.top = '';
                }
                this.currentShape = null; this.ghostShape = null;
            };
            document.addEventListener('mousemove', move); document.addEventListener('touchmove', move, {passive: false});
            document.addEventListener('mouseup', end); document.addEventListener('touchend', end);
        }
        canPlace(matrix, x, y) {
            if(x===undefined || y===undefined) return false;
            for(let r=0; r<matrix.length; r++) {
                for(let c=0; c<matrix[0].length; c++) {
                    if(matrix[r][c]) {
                        const nx = x + c; const ny = y + r;
                        if(nx < 0 || nx >= this.gridSize || ny < 0 || ny >= this.gridSize || this.grid[ny][nx] !== 0) return false;
                    }
                }
            }
            return true;
        }
        place(shape, x, y) {
            for(let r=0; r<shape.m.length; r++) {
                for(let c=0; c<shape.m[0].length; c++) {
                    if(shape.m[r][c]) this.grid[y+r][x+c] = shape.color;
                }
            }
            this.checkLines();
        }
        checkLines() {
            let rowsToClear = []; let colsToClear = [];
            for(let r=0; r<this.gridSize; r++) if(this.grid[r].every(cell => cell !== 0)) rowsToClear.push(r);
            for(let c=0; c<this.gridSize; c++) {
                let full = true; for(let r=0; r<this.gridSize; r++) if(this.grid[r][c] === 0) full = false;
                if(full) colsToClear.push(c);
            }
            const totalLines = rowsToClear.length + colsToClear.length;
            if(totalLines > 0) {
                rowsToClear.forEach(r => this.grid[r].fill(0));
                colsToClear.forEach(c => { for(let r=0; r<this.gridSize; r++) this.grid[r][c] = 0; });
                Sound.clear(totalLines);
                let coinsEarned = totalLines * 10; if(totalLines > 1) coinsEarned *= totalLines;
                userCoins += coinsEarned; updateUI();
                const el = document.createElement('div'); el.className = 'float-text'; el.innerText = `+${coinsEarned} ğŸŒ¿`;
                el.style.left = '50%'; el.style.top = '50%'; document.body.appendChild(el); setTimeout(() => el.remove(), 1000);
            }
        }
        checkGameOver() {
            setTimeout(() => {
                const remainingEls = document.querySelectorAll('#spawn-area .shape-preview');
                if(remainingEls.length === 0) return;
                let canFitAny = false;
                for(let i=0; i<remainingEls.length; i++) {
                    const shape = remainingEls[i].shapeData;
                    for(let y=0; y<this.gridSize; y++) {
                        for(let x=0; x<this.gridSize; x++) {
                            if(this.canPlace(shape.m, x, y)) { canFitAny = true; break; }
                        }
                        if(canFitAny) break;
                    }
                    if(canFitAny) break;
                }
                if(!canFitAny) this.triggerGameOver();
            }, 100);
        }
        triggerGameOver() {
            this.isGameOver = true; Sound.fail();
            document.getElementById('board-container').classList.add('board-shake');
            Pet.setMood('sad');
            setTimeout(() => { document.getElementById('game-over-modal').style.display = 'flex'; }, 800);
        }
        reset() {
            this.grid = Array(this.gridSize).fill().map(() => Array(this.gridSize).fill(0));
            this.isGameOver = false;
            document.getElementById('game-over-modal').style.display = 'none';
            document.getElementById('board-container').classList.remove('board-shake');
            Pet.updateUI(); this.spawnShapes();
        }
    }

    function switchPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(`${pageId}-page`).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        event.currentTarget.classList.add('active');
        if(pageId === 'shop') updateUI();
    }
    const Admin = {
        uploadLog: function(itemName) {
            if(!DreamloConfig.privateKey) return;
            const msg = `å…Œæ›ï¼š${itemName}`; const score = 2000000000 - Math.floor(Date.now() / 1000); 
            const uniqueName = `${msg}_${Math.floor(Math.random()*100)}`;
            const url = `https://www.dreamlo.com/lb/${DreamloConfig.privateKey}/add/${encodeURIComponent(uniqueName)}/${score}`;
            fetch(url).catch(e => console.log("Upload failed"));
        },
        showLogs: function() { alert("å¾Œå°åŠŸèƒ½ï¼šè«‹å¡«å…¥ Dreamlo Key"); }
    };
    const game = new BlockPuzzle();
    document.body.addEventListener('touchmove', function(e) { e.preventDefault(); }, { passive: false });
</script>
</body>
</html>
