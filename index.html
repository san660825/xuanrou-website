<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>ç„¡å°¾ç†Šè¨±é¡˜æ±  ğŸ¨ğŸ¯</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffcdd2">
    
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Varela+Round&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-gradient: linear-gradient(180deg, #fff0f5 0%, #ffebee 100%);
            --text-main: #880e4f;
            --accent: #ff80ab;
        }

        /* === é–æ­»ç¶²é ï¼Œç¦æ­¢ä»»ä½•æ²å‹• === */
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; position: fixed;
            overscroll-behavior: none; touch-action: none;
            background: var(--bg-gradient);
            font-family: 'Varela Round', sans-serif;
            user-select: none; -webkit-user-select: none;
        }

        #app-container {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: space-between;
        }

        /* 1. é ‚éƒ¨è³‡è¨Šåˆ— */
        .header-bar {
            height: 90px; width: 100%;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 100;
        }
        .pet-section { display: flex; align-items: center; gap: 8px; }
        #koala-icon { width: 50px; height: 50px; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1)); }
        .status-box { display: flex; flex-direction: column; gap: 2px; }
        .hunger-track { width: 60px; height: 6px; background: #ffcdd2; border-radius: 5px; overflow: hidden; }
        .hunger-fill { width: 50%; height: 100%; background: #ff4081; }
        .feed-btn { font-size: 0.6rem; padding: 2px 8px; background: #ff80ab; color: white; border:none; border-radius:10px; }
        .menu-section { display: flex; gap: 15px; align-items: center; }
        .score-display { font-family: 'Fredoka'; font-size: 1.2rem; color: #ec407a; font-weight: bold; }
        .nav-btn { font-size: 1.2rem; color: #ff80ab; background: white; width: 35px; height: 35px; border-radius: 50%; display:flex; align-items:center; justify-content:center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* 2. éŠæˆ²ä¸»å€åŸŸ (ç½®ä¸­) */
        .game-area {
            flex: 1; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 10px; position: relative;
        }
        #board-container {
            width: 90vw; max-width: 360px; aspect-ratio: 1/1;
            background: #fff; border-radius: 16px; padding: 8px;
            box-shadow: 0 8px 0 #f8bbd0, 0 10px 20px rgba(0,0,0,0.1);
            border: 4px solid #ffebee;
        }
        canvas#game-canvas { width: 100%; height: 100%; border-radius: 10px; display: block; }
        .board-shake { animation: shake 0.5s both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        /* 3. åº•éƒ¨ç”Ÿæˆå€ */
        #spawn-area {
            height: 110px; width: 100%;
            display: flex; justify-content: space-around; align-items: center;
            background: rgba(255,255,255,0.3); padding-bottom: 10px;
        }
        .shape-preview { width: 60px; height: 60px; touch-action: none; }
        .shape-preview.dragging {
            opacity: 0.9; z-index: 9999; position: fixed;
            transform: scale(1.2); pointer-events: none;
            will-change: left, top;
            /* ä¿®æ­£ï¼šè®“æ‰‹æŒ‡ä½æ–¼å…ƒç´ æ­£ä¸­å¿ƒ */
            margin-left: 0; margin-top: 0;
        }

        /* å•†åº— & å½ˆçª— */
        #shop-overlay {
            position: fixed; top: 90px; left: 0; width: 100%; height: calc(100% - 90px);
            background: #fff0f5; display: none; flex-direction: column;
            padding: 20px; overflow-y: auto; z-index: 200;
        }
        .shop-item {
            background: white; padding: 15px; margin-bottom: 10px; border-radius: 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #game-over-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 10000;
            display: flex; justify-content: center; align-items: center;
            display: none; backdrop-filter: blur(2px);
        }
        .modal-content { background: white; padding: 25px; border-radius: 25px; text-align: center; width: 80%; max-width: 300px; border: 4px solid #ffcdd2; }
        .btn-restart { background: #ff4081; color: white; border: none; padding: 10px 30px; border-radius: 20px; font-weight: bold; margin-top: 15px; }
        
        .float-text { position: absolute; font-family: 'Fredoka'; font-weight: 900; color: #ff4081; font-size: 1.5rem; pointer-events: none; z-index: 5000; animation: floatUp 0.8s forwards; text-shadow: 2px 2px 0 white; }
        @keyframes floatUp { 0% { transform:translateY(0); opacity:0; } 50% { opacity:1; } 100% { transform:translateY(-50px); opacity:0; } }
        .bubble { position: absolute; top: 95px; left: 20px; background: white; padding: 5px 10px; border-radius: 10px; border: 2px solid #ffcdd2; font-size: 0.8rem; color: #880e4f; opacity: 0; transition: 0.3s; pointer-events: none; }
        .bubble.show { opacity: 1; transform: translateY(5px); }
    </style>
</head>
<body>

<div id="app-container">
    <div class="header-bar">
        <div class="pet-section">
            <svg id="koala-icon" viewBox="0 0 100 100" onclick="petKoala()">
                <circle cx="50" cy="50" r="45" fill="#eceff1"/>
                <circle cx="20" cy="30" r="15" fill="#cfd8dc"/> <circle cx="80" cy="30" r="15" fill="#cfd8dc"/>
                <g id="eyes"><circle cx="35" cy="45" r="5" fill="#455a64"/><circle cx="65" cy="45" r="5" fill="#455a64"/></g>
                <ellipse cx="50" cy="55" rx="10" ry="7" fill="#455a64"/>
                <circle cx="25" cy="60" r="6" fill="rgba(255,128,171,0.4)"/> <circle cx="75" cy="60" r="6" fill="rgba(255,128,171,0.4)"/>
            </svg>
            <div class="status-box">
                <div class="hunger-track"><div class="hunger-fill" id="hunger-bar"></div></div>
                <button class="feed-btn" onclick="feed()">é¤µé£Ÿ</button>
            </div>
        </div>
        <div class="menu-section">
            <div class="score-display">ğŸŒ¿ <span id="score">0</span></div>
            <div class="nav-btn" onclick="toggleShop()"><i class="fas fa-gift"></i></div>
        </div>
    </div>
    <div class="bubble" id="msg">ä¸»äººï½</div>
    <div class="game-area">
        <div id="board-container">
            <canvas id="game-canvas" width="800" height="800"></canvas>
        </div>
    </div>
    <div id="spawn-area"></div>
</div>

<div id="shop-overlay">
    <h2 style="color:#880e4f; margin-bottom:20px;">è¨±é¡˜æ¸…å–®</h2>
    <div id="shop-list"></div>
    <button onclick="toggleShop()" style="margin-top:20px; padding:10px; background:#ddd; border:none; border-radius:10px;">é—œé–‰</button>
</div>

<div id="game-over-modal">
    <div class="modal-content">
        <div style="font-size:3rem;">ğŸ˜­</div>
        <h3 style="color:#880e4f;">æ²’åœ°æ–¹æ”¾äº†</h3>
        <p style="color:#666; font-size:0.9rem;">ç„¡å°¾ç†Šè¦ºå¾—å¯æƒœ...</p>
        <button class="btn-restart" onclick="game.reset()">å†ç©ä¸€æ¬¡</button>
    </div>
</div>

<script>
    /* é¤Šæˆæ•¸æ“š */
    let coins = parseInt(localStorage.getItem('xr_coins') || 0);
    let hunger = parseInt(localStorage.getItem('xr_hunger') || 50);
    const PRIZES = [{n:'æ‰‹æ–é£²', p:8000}, {n:'æŒ‰æ‘©', p:30000}, {n:'å¤§é¤', p:88000}, {n:'æ¸…ç©ºè³¼ç‰©è»Š', p:9999999}];

    function updateUI() {
        document.getElementById('score').innerText = coins;
        document.getElementById('hunger-bar').style.width = hunger + '%';
        localStorage.setItem('xr_coins', coins);
        localStorage.setItem('xr_hunger', hunger);
    }
    updateUI();

    function feed() {
        if(coins >= 50) {
            if(hunger>=100) return speak("é£½äº†ï¼");
            coins -= 50; hunger = Math.min(100, hunger+20);
            updateUI(); speak("å¥½åƒï¼");
        } else speak("æ²’éŒ¢...");
    }
    
    let clicks = 0;
    function petKoala() {
        clicks++;
        if(clicks===10) { coins+=10000; updateUI(); alert("ç”·å‹æ•‘æ˜Ÿï¼+10000"); clicks=0; }
        else speak("æ„›å¦³å–” â¤ï¸");
    }

    function speak(text) {
        const b = document.getElementById('msg'); b.innerText = text;
        b.classList.add('show'); setTimeout(()=>b.classList.remove('show'), 2000);
    }

    function toggleShop() {
        const s = document.getElementById('shop-overlay');
        s.style.display = s.style.display === 'flex' ? 'none' : 'flex';
        if(s.style.display === 'flex') {
            const l = document.getElementById('shop-list'); l.innerHTML = '';
            PRIZES.forEach(p => {
                l.innerHTML += `<div class="shop-item">
                    <div><b>${p.n}</b><br><small>${p.p}</small></div>
                    <button onclick="buy('${p.n}',${p.p})" style="background:#ff80ab; color:white; border:none; padding:5px 10px; border-radius:10px;">å…Œæ›</button>
                </div>`;
            });
        }
    }
    function buy(n, p) {
        if(coins>=p) { coins-=p; updateUI(); alert(`å…Œæ›æˆåŠŸï¼š${n}`); } else alert("éŒ¢ä¸å¤ ï¼");
    }

    /* éŠæˆ²å¼•æ“ (è¶…é«˜éˆæ•åº¦ç‰ˆ) */
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const SHAPES = [
        {m:[[1]], c:'#ff8a80'}, {m:[[1,1]], c:'#ff80ab'}, {m:[[1],[1]], c:'#ea80fc'},
        {m:[[1,1,1]], c:'#b388ff'}, {m:[[1,1],[1,1]], c:'#8c9eff'}, {m:[[1,1,1],[0,1,0]], c:'#80d8ff'}
    ];
    let grid = Array(8).fill().map(()=>Array(8).fill(0));
    let currentDrag = null;
    let ghost = null;
    const CELL = 100;

    function draw() {
        ctx.clearRect(0,0,800,800);
        ctx.strokeStyle = '#ffebee'; ctx.lineWidth=2;
        for(let i=0;i<=8;i++) {
            ctx.beginPath(); ctx.moveTo(0,i*CELL); ctx.lineTo(800,i*CELL); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(i*CELL,0); ctx.lineTo(i*CELL,800); ctx.stroke();
        }
        if(ghost) drawShape(ghost.shape, ghost.x, ghost.y, 'rgba(0,0,0,0.15)');
        for(let y=0;y<8;y++) for(let x=0;x<8;x++) if(grid[y][x]) drawCell(x,y,grid[y][x]);
        requestAnimationFrame(draw);
    }
    
    function drawCell(x,y,c) {
        let p=4, s=CELL-p*2;
        ctx.fillStyle=c; 
        ctx.beginPath(); ctx.roundRect(x*CELL+p, y*CELL+p, s, s, 15); ctx.fill();
    }
    function drawShape(s,x,y,c) {
        for(let r=0;r<s.m.length;r++) for(let c2=0;c2<s.m[0].length;c2++) if(s.m[r][c2]) drawCell(x+c2, y+r, c || s.c);
    }

    function spawn() {
        const area = document.getElementById('spawn-area'); area.innerHTML = '';
        for(let i=0;i<3;i++) {
            const data = SHAPES[Math.floor(Math.random()*SHAPES.length)];
            const el = document.createElement('canvas');
            el.width=60; el.height=60; el.className='shape-preview';
            const c = el.getContext('2d');
            const s=12, ox=(60-data.m[0].length*s)/2, oy=(60-data.m.length*s)/2;
            c.fillStyle=data.c;
            for(let r=0;r<data.m.length;r++) for(let col=0;col<data.m[0].length;col++) 
                if(data.m[r][col]) c.fillRect(ox+col*s, oy+r*s, s-1, s-1);
            
            el.addEventListener('touchstart', (e)=>startDrag(e, el, data), {passive:false});
            el.addEventListener('mousedown', (e)=>startDrag(e, el, data));
            area.appendChild(el);
        }
        checkOver();
    }

    function startDrag(e, el, data) {
        e.preventDefault();
        currentDrag = { el, data };
        el.classList.add('dragging');
        moveDrag(e);
    }

    function moveDrag(e) {
        if(!currentDrag) return;
        const evt = e.touches ? e.touches[0] : e;
        const el = currentDrag.el;
        
        // 1. è¦–è¦ºä½ç½®ä¿®æ­£ï¼šç¢ºä¿æ–¹å¡Šä¸­å¿ƒå°æº–æ‰‹æŒ‡ X è»¸
        const offset = 80; // å‘ä¸Šåç§»é‡
        const elWidth = 60; // æ–¹å¡Šå¯¬åº¦
        el.style.left = (evt.clientX - elWidth/2) + 'px'; // å®Œç¾ç½®ä¸­
        el.style.top = (evt.clientY - elWidth/2 - offset) + 'px';

        // 2. åº§æ¨™è¨ˆç®—
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        // é—œéµï¼šè¨ˆç®—ã€Œè¦–è¦ºä¸­å¿ƒã€åœ¨ Canvas ä¸Šçš„ä½ç½®
        const canvasX = (evt.clientX - rect.left) * scaleX;
        const canvasY = (evt.clientY - offset - rect.top) * scaleY;

        const gx = Math.floor(canvasX / CELL);
        const gy = Math.floor(canvasY / CELL);

        // 3. è¶…å¼·åŠ›ç£å¸ (æœå°‹ç¯„åœæ“´å¤§ï¼Œä¸¦æ‰¾æœ€è¿‘çš„)
        const shape = currentDrag.data;
        const px = gx - Math.floor(shape.m[0].length/2);
        const py = gy - Math.floor(shape.m.length/2);

        let best = null;
        let minDistance = Infinity; // è¨˜éŒ„æœ€çŸ­è·é›¢

        // æ“´å¤§æœå°‹ç¯„åœåˆ° 5x5 (dx, dy å¾ -2 åˆ° 2)
        for(let dy=-2; dy<=2; dy++) {
            for(let dx=-2; dx<=2; dx++) {
                const tx = px + dx;
                const ty = py + dy;
                
                if(canPlace(shape.m, tx, ty)) {
                    // è¨ˆç®—è·é›¢ (æ­å¹¾é‡Œå¾—è·é›¢)
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if(dist < minDistance) {
                        minDistance = dist;
                        best = {x: tx, y: ty};
                    }
                }
            }
        }
        ghost = best ? {x:best.x, y:best.y, shape:shape} : null;
    }

    function endDrag() {
        if(!currentDrag) return;
        if(ghost) {
            place(ghost.shape, ghost.x, ghost.y);
            currentDrag.el.remove();
            if(document.getElementById('spawn-area').children.length===0) setTimeout(spawn, 300);
            else checkOver();
        } else {
            currentDrag.el.classList.remove('dragging');
            currentDrag.el.style.left=''; currentDrag.el.style.top='';
        }
        currentDrag = null; ghost = null;
    }

    document.addEventListener('touchmove', moveDrag, {passive:false});
    document.addEventListener('mousemove', moveDrag);
    document.addEventListener('touchend', endDrag);
    document.addEventListener('mouseup', endDrag);

    function canPlace(m, x, y) {
        for(let r=0;r<m.length;r++) for(let c=0;c<m[0].length;c++) {
            if(m[r][c]) {
                let nx=x+c, ny=y+r;
                if(nx<0||nx>=8||ny<0||ny>=8||grid[ny][nx]) return false;
            }
        }
        return true;
    }
    function place(s, x, y) {
        for(let r=0;r<s.m.length;r++) for(let c=0;c<s.m[0].length;c++) 
            if(s.m[r][c]) grid[y+r][x+c] = s.c;
        checkLines();
    }
    function checkLines() {
        let lines = 0;
        for(let y=0;y<8;y++) if(grid[y].every(c=>c)) { grid[y].fill(0); lines++; }
        for(let x=0;x<8;x++) {
            let full=true; for(let y=0;y<8;y++) if(!grid[y][x]) full=false;
            if(full) { for(let y=0;y<8;y++) grid[y][x]=0; lines++; }
        }
        if(lines>0) {
            coins += lines*10; updateUI();
            const f = document.createElement('div'); f.className='float-text'; f.innerText=`+${lines*10}`;
            f.style.left='50%'; f.style.top='50%'; document.body.appendChild(f); setTimeout(()=>f.remove(),800);
        }
    }

    function checkOver() {
        setTimeout(()=>{
            const els = document.querySelectorAll('#spawn-area .shape-preview');
            if(els.length===0) return;
            // é€™è£¡çœç•¥è¤‡é›œæª¢æŸ¥ï¼Œå¯¦æˆ°ä¸­å¯åŠ å›
        }, 100);
    }

    const game = {
        reset: function() {
            grid = Array(8).fill().map(()=>Array(8).fill(0));
            document.getElementById('game-over-modal').style.display='none';
            spawn();
        }
    };

    draw(); spawn();
</script>
</body>
</html>
